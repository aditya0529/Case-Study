# AWS Config Custom Rule
IAMAccessKeyComplianceRule:
  Type: AWS::Config::ConfigRule
  Properties:
    ConfigRuleName: iam-access-key-rotation-compliance
    Description: Checks whether IAM users' access keys are rotated within the specified number of months.
    Scope:
      ComplianceResourceTypes:
        - AWS::IAM::User
    Source:
      Owner: CUSTOM_LAMBDA
      SourceIdentifier: !GetAtt IAMAccessKeyComplianceFunction.Arn
      SourceDetails:
        - EventSource: aws.config
          MessageType: ConfigurationItemChangeNotification
          ResourceTypesScope:
            - AWS::IAM::User
        - EventSource: aws.config
          MessageType: ScheduledNotification
          MaximumExecutionFrequency: TwentyFour_Hours
    InputParameters:
      RotationThresholdMonths: !Ref RotationThresholdMonths
IAMAccessKeyCompliancePermission:
  Type: AWS::Lambda::Permission
  Properties:
    FunctionName: !Ref IAMAccessKeyComplianceFunction
    Action: lambda:InvokeFunction
    Principal: config.amazonaws.com
    SourceArn: !Sub 'arn:${AWS::Partition}:config:${AWS::Region}:${AWS::AccountId}:config-rule/${IAMAccessKeyComplianceRule}'
